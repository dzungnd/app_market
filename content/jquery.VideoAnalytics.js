(function($){$.fn.VideoAnalytics=function(options){options=$.extend({url:ajaxPage,type:"POST"},options);var buffertime=[];var counter=1;var $this=this;var video=$this[0];var playtime;var timespent=0;$.fn.sendData=function(){var count=sessionStorage.length;if(count){$.ajax({url:options.url,type:options.type,data:{sessionStore:JSON.stringify(sessionStorage),action:"vlog"},success:function(){sessionStorage.clear();}});}};$.fn.setSessionItem=function(name,value){sessionStorage.setItem("fId_"+$this.attr("data_mid")+"_"+name,value);};$.fn.getSessionItem=function(name){return sessionStorage.getItem("fId_"+$this.attr("data_mid")+"_"+name);};$.fn.calculate=function(){var parsed=JSON.parse($.fn.getSessionItem("time_ranges"));var totalviewtime=$(this).objectToArray(parsed);var add=[];var total=0;var time_ranges=video.played;var totalviewtime=[];for(var i=0;i<time_ranges.length;i++){var start=Math.round(time_ranges.start(i));var end=Math.round(time_ranges.end(i));totalviewtime.push(start+"-"+end);}$(this).setSessionItem("time_ranges",JSON.stringify(totalviewtime));for(var value in totalviewtime){var res=totalviewtime[value].split("-");var x=Number(res[1])-Number(res[0]);add.push(x);}$.each(add,function(){total+=this;});return total;};$.fn.videoStart=function(fileid){playtime=$(this).getTimeInMs();$(this).setSessionItem("total_view_time",$(this).calculate());if(timespent==0){timespent=$(this).getTimeInMs();}};$.fn.videoPlaying=function(){var playingtime=$(this).getTimeInMs();var buffer=[];buffertime=playingtime-playtime;if(counter==1){$(this).setSessionItem("initial_buffer_time",buffertime);$(this).setSessionItem("fileid",$this.attr("data_mid"));++counter;}if($.fn.getSessionItem("buffer_time")!=null){var data=JSON.parse($.fn.getSessionItem("buffer_time"));buffer=$(this).objectToArray(data);}buffer.push(buffertime);$(this).setSessionItem("buffer_time",JSON.stringify(buffer));};$.fn.videoEnd=function(){$(this).setSessionItem("ended",1);$(this).setVideoData();};$.fn.setVideoData=function(){var total_time_spent=$(this).getTimeInMs()-timespent;$(this).setSessionItem("timespent",total_time_spent);$(this).setSessionItem("duration",video.duration);$(this).setSessionItem("fileid",$this.attr("data_mid"));$(this).setSessionItem("total_view_time",$(this).calculate());};$.fn.objectToArray=function(obj){var arr=[];for(var x in obj){arr.push(obj[x]);}return arr;};$.fn.getTimeInMs=function(){var d=new Date();return d.getTime();};$(this).sendData();return $this;};})(jQuery);$(document).ready(function(){try{if(typeof(Storage)!=="undefined"){var playStatus=0;var videoAnalysis=$("video").VideoAnalytics();$(".videoanalytics").bind("play seeked",function(e){videoAnalysis.videoStart($(this).attr("data_mid"));playStatus=1;});$(".videoanalytics").bind("ended",function(e){videoAnalysis.videoEnd();});$(".videoanalytics").bind("playing",function(e){videoAnalysis.videoPlaying();});$(window).unload(function(){if(playStatus){videoAnalysis.setVideoData();videoAnalysis.sendData();}});}}catch(err){}});